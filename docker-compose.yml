version: '3.8'

services:
  # 애플리케이션 서비스
  deokhugam-app:
    container_name: deokhugam-app
    build: . # 현재 디렉토리의 Dockerfile 사용
    ports:
      - "8080:8080" # 호스트 8080, 컨테이너 8080
    env_file:
      - .env # 환경변수 주입
    environment:
      # DB 접속 정보
      - SPRING_DATASOURCE_URL=${DOCKER_DATASOURCE_URL}
      # Storage 설정 (추가)
      - STORAGE_TYPE=${STORAGE_TYPE}
      - AWS_S3_ACCESS_KEY=${AWS_S3_ACCESS_KEY}
      - AWS_S3_SECRET_KEY=${AWS_S3_SECRET_KEY}
      - AWS_S3_REGION=${AWS_S3_REGION}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
    depends_on:
      - deokhugam-db # DB 가장 먼저 실행
    volumes:
      - ./.deokhugam:/app/.deokhugam # 로컬 파일 저장소
      - ./.deokhugam-files:/app/.deokhugam-files # 파일 저장소
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - deokhugam-network

  # DB 서비스 (PostgreSQL)
  deokhugam-db:
    container_name: deokhugam-db
    image: postgres:17.2
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./.postgres-data:/var/lib/postgresql/data # DB 데이터 유지
      # 초기화 스크립트 (최초 실행 시 자동 실행)
      - ./src/main/resources/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5432:5432" # 호스트 접속 가능
    networks:
      - deokhugam-network

networks:
  deokhugam-network:
    driver: bridge